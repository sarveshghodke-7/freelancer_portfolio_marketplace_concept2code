<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | TalentForge</title>
  <script src="js/theme.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="js/transitions.js" defer></script>
  <style>
    * {
      font-family: 'Inter', sans-serif;
    }

    body {
      background: #f1f3f8;
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€ */
    #sidebar {
      width: 260px;
      min-height: 100vh;
      flex-shrink: 0;
      background: linear-gradient(160deg, #0f0f0f 0%, #1a1035 100%);
      display: flex;
      flex-direction: column;
      padding: 1.75rem 1.25rem;
      position: sticky;
      top: 0;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: #fff;
      font-size: 1.15rem;
      font-weight: 800;
      text-decoration: none;
      margin-bottom: 2.5rem;
    }

    .sidebar-logo span {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      padding: 0.3rem 0.55rem;
      border-radius: 0.4rem;
      font-size: 0.8rem;
    }

    .nav-group {
      margin-bottom: 0.25rem;
    }

    .nav-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      color: #4b5563;
      text-transform: uppercase;
      padding: 0 0.75rem;
      margin-bottom: 0.4rem;
      margin-top: 1.25rem;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.65rem 0.85rem;
      border-radius: 0.7rem;
      font-size: 0.855rem;
      font-weight: 500;
      color: #9ca3af;
      transition: background 0.15s, color 0.15s;
      cursor: pointer;
      border: none;
      background: none;
      text-align: left;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.07);
      color: #e5e7eb;
    }

    .nav-btn.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.15));
      color: #a78bfa;
      font-weight: 600;
      box-shadow: inset 2px 0 0 #8b5cf6;
    }

    .nav-btn .nav-icon {
      font-size: 1rem;
      width: 1.25rem;
      text-align: center;
    }

    .nav-btn.danger {
      color: #f87171;
    }

    .nav-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .sidebar-bottom {
      margin-top: auto;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    /* â”€â”€â”€ User avatar widget â”€â”€â”€ */
    #sidebarUser {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.8rem;
    }

    #sidebarAvatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: white;
      flex-shrink: 0;
    }

    #sidebarName {
      font-size: 0.85rem;
      font-weight: 600;
      color: #f3f4f6;
    }

    #sidebarEmail {
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* â”€â”€â”€ Main â”€â”€â”€ */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 2.25rem 2.5rem;
      min-height: 100vh;
    }

    /* â”€â”€â”€ Top bar â”€â”€â”€ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .topbar h1 {
      font-size: 1.6rem;
      font-weight: 800;
      color: #0f0f0f;
    }

    .topbar p {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    .role-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .role-freelancer {
      background: #ede9fe;
      color: #7c3aed;
    }

    .role-client {
      background: #dbeafe;
      color: #1d4ed8;
    }

    /* â”€â”€â”€ Stat cards â”€â”€â”€ */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      border-radius: 1.25rem;
      padding: 1.4rem 1.5rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    .stat-card .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .stat-card .stat-val {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1;
    }

    .stat-card .stat-label {
      font-size: 0.78rem;
      font-weight: 500;
      margin-top: 0.3rem;
      opacity: 0.8;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      right: -20px;
      top: -20px;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.07);
      pointer-events: none;
    }

    /* Color variants */
    .sc-indigo {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
    }

    .sc-purple {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .sc-emerald {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .sc-amber {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .sc-rose {
      background: linear-gradient(135deg, #f43f5e, #e11d48);
      color: white;
    }

    .sc-sky {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    /* â”€â”€â”€ Section cards â”€â”€â”€ */
    .panel {
      background: white;
      border-radius: 1.25rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #f1f3f8;
      margin-bottom: 1.75rem;
      animation: panelIn 0.3s ease;
    }

    @keyframes panelIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    .panel-header {
      padding: 1.4rem 1.75rem;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header h2 {
      font-size: 1rem;
      font-weight: 700;
      color: #0f0f0f;
    }

    .panel-header p {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }

    .panel-body {
      padding: 1.5rem 1.75rem;
    }

    /* â”€â”€â”€ Request cards â”€â”€â”€ */
    .req-card {
      border: 1.5px solid #f1f3f8;
      border-radius: 1rem;
      padding: 1.2rem 1.4rem;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: white;
      position: relative;
      overflow: hidden;
    }

    .req-card:hover {
      border-color: #6366f1;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.08);
    }

    .req-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #e5e7eb;
      border-radius: 9999px 0 0 9999px;
      transition: background 0.2s;
    }

    .req-card:hover::before {
      background: #6366f1;
    }

    .req-card.status-accepted::before {
      background: #10b981;
    }

    .req-card.status-rejected::before {
      background: #f43f5e;
    }

    .req-card.status-pending::before {
      background: #f59e0b;
    }

    /* â”€â”€â”€ Status badges â”€â”€â”€ */
    .sbadge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.7rem;
      border-radius: 9999px;
      font-size: 0.72rem;
      font-weight: 600;
    }

    .sbadge-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .sbadge-accepted {
      background: #d1fae5;
      color: #065f46;
    }

    .sbadge-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    /* â”€â”€â”€ Action buttons â”€â”€â”€ */
    .action-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.9rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.15s;
      cursor: pointer;
      border: none;
    }

    .ap-green {
      background: #d1fae5;
      color: #065f46;
    }

    .ap-green:hover {
      background: #6ee7b7;
    }

    .ap-red {
      background: #fee2e2;
      color: #991b1b;
    }

    .ap-red:hover {
      background: #fca5a5;
    }

    .ap-indigo {
      background: #ede9fe;
      color: #5b21b6;
    }

    .ap-indigo:hover {
      background: #c4b5fd;
    }

    .ap-dark {
      background: #111;
      color: white;
    }

    .ap-dark:hover {
      background: #6366f1;
    }

    .ap-gray {
      background: #f3f4f6;
      color: #374151;
    }

    .ap-gray:hover {
      background: #d1d5db;
    }

    /* â”€â”€â”€ Form inputs â”€â”€â”€ */
    .tf-input {
      width: 100%;
      padding: 0.7rem 1rem;
      font-size: 0.875rem;
      border: 1.5px solid #e5e7eb;
      border-radius: 0.75rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-family: inherit;
      background: white;
    }

    .tf-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    /* â”€â”€â”€ CTA banner â”€â”€â”€ */
    .cta-banner {
      border-radius: 1.25rem;
      padding: 1.6rem 2rem;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1035 60%, #312e81 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.75rem;
      overflow: hidden;
      position: relative;
    }

    .cta-banner::after {
      content: '';
      position: absolute;
      right: -40px;
      top: -40px;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.12);
    }

    /* â”€â”€â”€ Settings toggle â”€â”€â”€ */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 9999px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle.on {
      background: #6366f1;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      transition: transform 0.2s;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle.on::after {
      transform: translateX(20px);
    }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 1.75rem;
      right: 1.75rem;
      background: #111;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      z-index: 9999;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* â”€â”€â”€ Loading spinner â”€â”€â”€ */
    .spin-ring {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 2.5px solid #e5e7eb;
      border-top-color: #6366f1;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€â”€ Dark mode â”€â”€â”€ */
    [data-theme="dark"] body {
      background: #080808;
    }

    [data-theme="dark"] #sidebar {
      background: linear-gradient(160deg, #0a0a0a 0%, #100c24 100%);
    }

    [data-theme="dark"] main {
      color: #f3f4f6;
    }

    [data-theme="dark"] .topbar h1 {
      color: #f3f4f6;
    }

    [data-theme="dark"] .panel,
    [data-theme="dark"] .req-card,
    [data-theme="dark"] .tf-input {
      background: #141414 !important;
      border-color: #272727 !important;
      color: #f3f4f6;
    }

    [data-theme="dark"] .panel-header {
      border-bottom-color: #272727 !important;
    }

    [data-theme="dark"] .panel-header h2 {
      color: #f3f4f6;
    }

    [data-theme="dark"] .tf-input {
      color: #f3f4f6;
    }

    [data-theme="dark"] .text-gray-700 {
      color: #d1d5db !important;
    }

    [data-theme="dark"] .text-gray-500 {
      color: #9ca3af !important;
    }
  </style>
</head>

<body>
  <div id="toast"></div>

  <div style="display:flex; min-height:100vh;">

    <!-- â•â• SIDEBAR â•â• -->
    <aside id="sidebar">
      <a href="index.html" class="sidebar-logo">
        <span>{</ />}</span> TalentForge
      </a>

      <!-- User widget -->
      <div id="sidebarUser">
        <div id="sidebarAvatar">?</div>
        <div>
          <div id="sidebarName">Loadingâ€¦</div>
          <div id="sidebarEmail"></div>
        </div>
      </div>

      <nav id="sidebarNav"></nav>

      <div class="sidebar-bottom">
        <!-- Dark mode toggle -->
        <button class="nav-btn" onclick="toggleDarkMode()" style="margin-bottom:0.25rem;">
          <span class="nav-icon" id="dmIcon">ğŸŒ™</span>
          <span id="dmLabel">Dark Mode</span>
        </button>
        <button id="navLogout" class="nav-btn danger">
          <span class="nav-icon">ğŸšª</span> Logout
        </button>
      </div>
    </aside>

    <!-- â•â• MAIN â•â• -->
    <main>

      <!-- Top bar -->
      <div class="topbar">
        <div>
          <h1 id="pageTitle">Dashboard</h1>
          <p id="pageSubtitle">Welcome back ğŸ‘‹</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="roleBadge" class="role-pill"></span>
        </div>
      </div>

      <!-- Loading state -->
      <div id="loadingState" class="flex flex-col items-center justify-center py-24 gap-4 text-gray-400">
        <div class="spin-ring"></div>
        <p class="text-sm font-medium">Loading your dashboardâ€¦</p>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• FREELANCER DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="developerDashboard" class="hidden">

        <!-- Stat cards -->
        <div class="stat-grid">
          <div class="stat-card sc-indigo">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">ğŸ“¥</div>
            <div class="stat-val" id="statTotal">â€”</div>
            <div class="stat-label">Total Requests</div>
          </div>
          <div class="stat-card sc-amber">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">â³</div>
            <div class="stat-val" id="statPending">â€”</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card sc-emerald">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">âœ…</div>
            <div class="stat-val" id="statAccepted">â€”</div>
            <div class="stat-label">Accepted</div>
          </div>
          <div class="stat-card sc-rose">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">âŒ</div>
            <div class="stat-val" id="statRejected">â€”</div>
            <div class="stat-label">Rejected</div>
          </div>
        </div>

        <!-- Profile section -->
        <div id="profileSection" class="panel">
          <div class="panel-header">
            <div>
              <h2>My Profile</h2>
              <p>Visible to clients who browse freelancers</p>
            </div>
            <span class="text-2xl">ğŸ‘¤</span>
          </div>
          <div class="panel-body">
            <form id="profileForm" class="space-y-5">
              <div class="grid md:grid-cols-2 gap-5">
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-1.5">Bio / About You</label>
                  <textarea id="bio" rows="3" placeholder="Write a short bio that describes your expertiseâ€¦"
                    class="tf-input" style="resize:vertical"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1.5">Skills <span
                      class="font-normal text-gray-400">(comma separated)</span></label>
                  <input type="text" id="skills" placeholder="e.g. React, Node.js, Python, AWS" class="tf-input">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1.5">Hourly Rate (USD)</label>
                  <div class="relative">
                    <span class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 font-semibold">$</span>
                    <input type="number" id="rate" placeholder="50" class="tf-input" style="padding-left:1.75rem">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1.5">Availability</label>
                  <select id="availability" class="tf-input">
                    <option value="available">âœ… Available</option>
                    <option value="busy">ğŸŸ¡ Busy</option>
                    <option value="unavailable">ğŸ”´ Unavailable</option>
                  </select>
                </div>
              </div>
              <button type="submit" id="saveProfileBtn" class="action-pill ap-dark px-6 py-2.5 text-sm">
                ğŸ’¾ Save Profile
              </button>
            </form>
          </div>
        </div>

        <!-- Incoming Requests -->
        <div id="requestsSection" class="panel">
          <div class="panel-header">
            <div>
              <h2>Incoming Hire Requests</h2>
              <p>Review and respond to clients who want to hire you</p>
            </div>
            <span class="text-2xl">ğŸ“¬</span>
          </div>
          <div class="panel-body">
            <div id="requestList" class="space-y-3"></div>
          </div>
        </div>

      </div><!-- /developerDashboard -->

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLIENT DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="clientDashboard" class="hidden">

        <!-- Stat cards -->
        <div class="stat-grid">
          <div class="stat-card sc-sky">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">ğŸ“¤</div>
            <div class="stat-val" id="clientStatTotal">â€”</div>
            <div class="stat-label">Requests Sent</div>
          </div>
          <div class="stat-card sc-emerald">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">ğŸ¤</div>
            <div class="stat-val" id="clientStatAccepted">â€”</div>
            <div class="stat-label">Accepted</div>
          </div>
          <div class="stat-card sc-purple">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">ğŸ</div>
            <div class="stat-val" id="clientStatProjects">â€”</div>
            <div class="stat-label">Active Projects</div>
          </div>
          <div class="stat-card sc-rose">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2)">ğŸ’³</div>
            <div class="stat-val" id="clientStatPaid">â€”</div>
            <div class="stat-label">Paid</div>
          </div>
        </div>

        <!-- CTA Banner -->
        <div class="cta-banner">
          <div style="position:relative;z-index:1">
            <p
              style="font-size:0.75rem;color:#a78bfa;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;margin-bottom:0.3rem;">
              Find Talent</p>
            <h3 style="font-size:1.2rem;font-weight:800;margin-bottom:0.3rem;">Ready to hire your next developer?</h3>
            <p style="font-size:0.82rem;color:#9ca3af;">Browse hundreds of skilled freelancers ready to work on your
              project.</p>
          </div>
          <a href="browse.html" style="position:relative;z-index:1"
            class="action-pill ap-dark px-6 py-3 text-sm flex-shrink-0 ml-6"
            style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">
            Browse Freelancers â†’
          </a>
        </div>

        <!-- Sent Requests -->
        <div class="panel">
          <div class="panel-header">
            <div>
              <h2>Your Sent Requests</h2>
              <p>Track the status of all your hire requests</p>
            </div>
            <span class="text-2xl">ğŸ“‹</span>
          </div>
          <div class="panel-body">
            <div id="clientRequestList" class="space-y-3"></div>
          </div>
        </div>

      </div><!-- /clientDashboard -->

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div id="settingsSection" class="hidden">
        <div class="panel" style="max-width:560px">
          <div class="panel-header">
            <div>
              <h2>Account Settings</h2>
              <p>Manage your preferences</p>
            </div>
            <span class="text-2xl">âš™ï¸</span>
          </div>
          <div class="panel-body space-y-4">
            <div class="flex items-center justify-between p-4 border border-gray-100 rounded-xl">
              <div>
                <p class="font-semibold text-sm">Email Notifications</p>
                <p class="text-gray-500 text-xs mt-0.5">Get notified about new hire requests</p>
              </div>
              <div class="toggle on" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="flex items-center justify-between p-4 border border-gray-100 rounded-xl">
              <div>
                <p class="font-semibold text-sm">Public Profile</p>
                <p class="text-gray-500 text-xs mt-0.5">Make your profile visible to clients</p>
              </div>
              <div class="toggle on" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="flex items-center justify-between p-4 border border-gray-100 rounded-xl">
              <div>
                <p class="font-semibold text-sm">Dark Mode</p>
                <p class="text-gray-500 text-xs mt-0.5">Toggle site-wide dark theme</p>
              </div>
              <div class="toggle" id="dmSettingsToggle" onclick="toggleDarkMode(); this.classList.toggle('on')"></div>
            </div>
            <div class="p-4 bg-red-50 border border-red-100 rounded-xl">
              <p class="font-bold text-sm text-red-700 mb-0.5">Danger Zone</p>
              <p class="text-xs text-red-500 mb-3">Permanently delete your account and all associated data.</p>
              <button class="action-pill ap-red text-xs" onclick="showToast('âš ï¸ Account deletion coming soon.')">Delete
                Account</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div><!-- /flex -->

  <script type="module">
    import {
      protectPage, getUserRole,
      getFreelancerProfile, saveFreelancerProfile,
      getFreelancerRequests, getClientRequests,
      getPaymentsByClient, updateRequestStatus, logoutUser
    } from "./js/auth.js";
    import { auth } from "./firebase/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    protectPage();

    /* â”€â”€ Toast â”€â”€ */
    window.showToast = function (msg, isErr = false) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.background = isErr ? "#dc2626" : "#111";
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 3500);
    };

    /* â”€â”€ Status badge HTML â”€â”€ */
    const statusBadge = (s) => {
      const map = {
        pending: ['â³', 'sbadge-pending', 'Pending'],
        accepted: ['âœ…', 'sbadge-accepted', 'Accepted'],
        rejected: ['âŒ', 'sbadge-rejected', 'Rejected'],
      };
      const [icon, cls, label] = map[s] || ['â€¢', 'sbadge-pending', s];
      return `<span class="sbadge ${cls}">${icon} ${label}</span>`;
    };

    function buildSidebar(role) {
      const nav = document.getElementById("sidebarNav");
      nav.innerHTML = "";

      if (role === "freelancer") {
        nav.innerHTML = `
        <div class="nav-label">Main</div>
        <button id="navDashboard" class="nav-btn active"><span class="nav-icon">ğŸ </span> Dashboard</button>
        <button id="navProfile"   class="nav-btn"><span class="nav-icon">ğŸ‘¤</span> My Profile</button>
        <button id="navRequests"  class="nav-btn"><span class="nav-icon">ğŸ“¥</span> Requests</button>
        <div class="nav-label">Account</div>
        <button id="navSettings"  class="nav-btn"><span class="nav-icon">âš™ï¸</span> Settings</button>`;

        document.getElementById("navDashboard").addEventListener("click", () => {
          showSection("developerDashboard", "navDashboard", "Dashboard", "Welcome back ğŸ‘‹");
          document.getElementById("profileSection").classList.remove("hidden");
          document.getElementById("requestsSection").classList.remove("hidden");
        });
        document.getElementById("navProfile").addEventListener("click", () => {
          showSection("developerDashboard", "navProfile", "My Profile", "Edit your public profile");
          document.getElementById("profileSection").classList.remove("hidden");
          document.getElementById("requestsSection").classList.add("hidden");
        });
        document.getElementById("navRequests").addEventListener("click", () => {
          showSection("developerDashboard", "navRequests", "Hire Requests", "Review incoming requests");
          document.getElementById("profileSection").classList.add("hidden");
          document.getElementById("requestsSection").classList.remove("hidden");
        });

      } else {
        nav.innerHTML = `
        <div class="nav-label">Main</div>
        <button id="navDashboard" class="nav-btn active"><span class="nav-icon">ğŸ </span> Dashboard</button>
        <button id="navRequests"  class="nav-btn"><span class="nav-icon">ğŸ“‹</span> My Requests</button>
        <button id="navBrowse"    class="nav-btn"><span class="nav-icon">ğŸ”</span> Browse Freelancers</button>
        <div class="nav-label">Account</div>
        <button id="navSettings"  class="nav-btn"><span class="nav-icon">âš™ï¸</span> Settings</button>`;

        document.getElementById("navDashboard").addEventListener("click", () =>
          showSection("clientDashboard", "navDashboard", "Dashboard", "Welcome back ğŸ‘‹"));
        document.getElementById("navRequests").addEventListener("click", () =>
          showSection("clientDashboard", "navRequests", "My Requests", "Track your hire requests"));
        document.getElementById("navBrowse").addEventListener("click", () =>
          window.location.href = "browse.html");
      }

      document.getElementById("navSettings").addEventListener("click", () =>
        showSection("settingsSection", "navSettings", "Settings", "Manage your account"));
    }

    /* â”€â”€ Section switcher â”€â”€ */
    function showSection(id, btnId, title, subtitle) {
      ["developerDashboard", "clientDashboard", "settingsSection"].forEach(s => {
        document.getElementById(s).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
      document.getElementById("pageTitle").textContent = title || "Dashboard";
      document.getElementById("pageSubtitle").textContent = subtitle || "";
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.add("active");
    }

    /* â”€â”€ Auth â”€â”€ */
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }

      // Sidebar user widget
      const initials = (user.email || "?")[0].toUpperCase();
      document.getElementById("sidebarAvatar").textContent = initials;
      document.getElementById("sidebarName").textContent = user.displayName || user.email.split("@")[0];
      document.getElementById("sidebarEmail").textContent = user.email;

      const role = await getUserRole(user.uid);
      document.getElementById("roleBadge").textContent = role === "freelancer" ? "ğŸ›  Freelancer" : "ğŸ’¼ Client";
      document.getElementById("roleBadge").className = `role-pill role-${role}`;

      buildSidebar(role);
      document.getElementById("loadingState").classList.add("hidden");

      document.getElementById("navLogout").addEventListener("click", async () => {
        await logoutUser(); window.location.href = "index.html";
      });

      if (role === "freelancer") {
        document.getElementById("developerDashboard").classList.remove("hidden");
        await loadFreelancerDash(user);
      } else {
        document.getElementById("clientDashboard").classList.remove("hidden");
        await loadClientDash(user);
      }
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FREELANCER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadFreelancerDash(user) {
      // Load profile
      try {
        const p = await getFreelancerProfile(user.uid);
        if (p) {
          if (p.bio) document.getElementById("bio").value = p.bio;
          if (p.skills) document.getElementById("skills").value = p.skills;
          if (p.rate) document.getElementById("rate").value = p.rate;
          if (p.availability) document.getElementById("availability").value = p.availability;
        }
      } catch { }

      // Profile save
      document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("saveProfileBtn");
        btn.textContent = "Savingâ€¦"; btn.disabled = true;
        try {
          const skillsVal = document.getElementById("skills").value.trim();
          const skillsArr = skillsVal ? skillsVal.split(",").map(s => s.trim()).filter(s => s !== "") : [];

          await saveFreelancerProfile(user.uid, {
            bio: document.getElementById("bio").value.trim(),
            skills: skillsArr,
            rate: document.getElementById("rate").value,
            availability: document.getElementById("availability").value,
            email: user.email,
            name: user.displayName || ""
          });
          showToast("âœ… Profile saved!");
        } catch (err) { showToast("Error: " + err.message, true); }
        finally { btn.textContent = "ğŸ’¾ Save Profile"; btn.disabled = false; }
      });

      // Requests
      let requests = [];
      try { requests = await getFreelancerRequests(user.uid); } catch { }

      const total = requests.length;
      const pending = requests.filter(r => r.status === "pending").length;
      const accepted = requests.filter(r => r.status === "accepted").length;
      const rejected = requests.filter(r => r.status === "rejected").length;

      document.getElementById("statTotal").textContent = total;
      document.getElementById("statPending").textContent = pending;
      document.getElementById("statAccepted").textContent = accepted;
      document.getElementById("statRejected").textContent = rejected;

      const list = document.getElementById("requestList");
      if (total === 0) {
        list.innerHTML = `
        <div class="text-center py-16 text-gray-400">
          <p class="text-5xl mb-4">ğŸ“­</p>
          <p class="font-semibold text-gray-500">No hire requests yet</p>
          <p class="text-sm mt-1">When clients send you requests, they'll appear here.</p>
        </div>`;
      } else {
        requests.forEach(r => {
          const canRespond = r.status === "pending";
          const isAccepted = r.status === "accepted";
          const msUrl = `milestones.html?requestId=${r.id}&freelancerId=${user.uid}&clientId=${r.clientId}&title=${encodeURIComponent((r.message || 'Project').substring(0, 40))}&budget=${r.budget}`;

          const card = document.createElement("div");
          card.className = `req-card status-${r.status}`;
          card.dataset.id = r.id;
          card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                ${statusBadge(r.status)}
                <span class="text-xs text-gray-400">${r.createdAt?.toDate?.()?.toLocaleDateString?.() || ""}</span>
              </div>
              <p class="font-bold text-base text-gray-900">Budget: <span class="text-emerald-600">$${r.budget}</span></p>
              <p class="text-gray-500 text-sm mt-1 leading-relaxed line-clamp-2">${r.message}</p>
            </div>
            <div class="flex flex-col gap-2 items-end flex-shrink-0">
              ${isAccepted ? `<a href="${msUrl}" class="action-pill ap-dark text-xs">ğŸ Milestones</a>` : ""}
            </div>
          </div>
          ${canRespond ? `
          <div class="flex gap-2 mt-3 pt-3 border-t border-gray-50">
            <button class="accept-btn action-pill ap-green flex-1 justify-center" data-id="${r.id}">âœ… Accept</button>
            <button class="reject-btn action-pill ap-red flex-1 justify-center" data-id="${r.id}">âŒ Reject</button>
          </div>` : ""}
        `;
          list.appendChild(card);
        });

        // Handlers
        list.querySelectorAll(".accept-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            btn.disabled = true; btn.textContent = "â€¦";
            await updateRequestStatus(btn.dataset.id, "accepted");
            const card = btn.closest(".req-card");
            card.className = "req-card status-accepted";
            card.querySelector(".flex.gap-2.mt-3").remove();
            card.querySelector(".sbadge").outerHTML = statusBadge("accepted");
            document.getElementById("statPending").textContent = parseInt(document.getElementById("statPending").textContent) - 1;
            document.getElementById("statAccepted").textContent = parseInt(document.getElementById("statAccepted").textContent) + 1;
            showToast("âœ… Request accepted!");
          });
        });
        list.querySelectorAll(".reject-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            btn.disabled = true; btn.textContent = "â€¦";
            await updateRequestStatus(btn.dataset.id, "rejected");
            const card = btn.closest(".req-card");
            card.className = "req-card status-rejected";
            card.querySelector(".flex.gap-2.mt-3").remove();
            document.getElementById("statPending").textContent = parseInt(document.getElementById("statPending").textContent) - 1;
            document.getElementById("statRejected").textContent = parseInt(document.getElementById("statRejected").textContent) + 1;
            showToast("âŒ Request rejected.");
          });
        });
      }

    }


    async function loadClientDash(user) {
      let requests = [], paidIds = new Set();
      try { requests = await getClientRequests(user.uid); } catch { }
      try {
        const payments = await getPaymentsByClient(user.uid);
        payments.forEach(p => paidIds.add(p.requestId));
      } catch { }

      const total = requests.length;
      const accepted = requests.filter(r => r.status === "accepted").length;
      const paid = paidIds.size;

      document.getElementById("clientStatTotal").textContent = total;
      document.getElementById("clientStatAccepted").textContent = accepted;
      document.getElementById("clientStatProjects").textContent = accepted;
      document.getElementById("clientStatPaid").textContent = paid;

      const list = document.getElementById("clientRequestList");
      if (total === 0) {
        list.innerHTML = `
        <div class="text-center py-16 text-gray-400">
          <p class="text-5xl mb-4">ğŸ“¤</p>
          <p class="font-semibold text-gray-500">No requests sent yet</p>
          <a href="browse.html" class="mt-3 inline-block text-indigo-500 text-sm font-semibold hover:underline">Browse Freelancers â†’</a>
        </div>`;
      } else {
        requests.forEach(r => {
          const isAccepted = r.status === "accepted";
          const alreadyPaid = paidIds.has(r.id);
          const payUrl = `payment.html?requestId=${r.id}&freelancerId=${r.freelancerId}&budget=${r.budget}&name=Freelancer`;
          const msUrl = `milestones.html?requestId=${r.id}&freelancerId=${r.freelancerId}&clientId=${user.uid}&title=${encodeURIComponent((r.message || 'Project').substring(0, 40))}&budget=${r.budget}`;

          const card = document.createElement("div");
          card.className = `req-card status-${r.status}`;
          card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                ${statusBadge(r.status)}
                <span class="text-xs text-gray-400">${r.createdAt?.toDate?.()?.toLocaleDateString?.() || ""}</span>
              </div>
              <p class="font-bold text-base text-gray-900">Budget: <span class="text-emerald-600">$${r.budget}</span></p>
              <p class="text-gray-500 text-sm mt-1 leading-relaxed line-clamp-2">${r.message}</p>
              <a href="profile.html?id=${r.freelancerId}" class="text-xs text-indigo-500 hover:underline mt-1.5 inline-block font-medium">View Freelancer â†’</a>
            </div>
            <div class="flex flex-col gap-2 items-end flex-shrink-0">
              ${isAccepted && !alreadyPaid ? `<a href="${payUrl}" class="action-pill ap-indigo text-xs">ğŸ’³ Pay Now</a>` : ""}
              ${isAccepted && alreadyPaid ? `<span class="action-pill ap-green text-xs">âœ… Paid</span>` : ""}
              ${isAccepted ? `<a href="${msUrl}" class="action-pill ap-dark text-xs">ğŸ Milestones</a>` : ""}
            </div>
          </div>
        `;
          list.appendChild(card);
        });
      }
    }
  </script>
</body>

</html>